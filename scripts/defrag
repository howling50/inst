#!/bin/bash

# Define log file
LOG_FILE="/var/log/auto_defrag_ntfs.log"

# Function to log messages
log_message() {
    local log_level="$1"
    local message="$2"
    logger -t "auto_defrag_ntfs" -p "user.$log_level" "$message"
    echo "$(date +"%Y-%m-%d %H:%M:%S") [$log_level] $message" >> "$LOG_FILE"
}

# Log start of script
log_message "info" "Starting automatic NTFS defragmentation."

# Check if drives are in use
drives_in_use=false

for drive in /dev/sda1 /dev/sdb1; do
    if mountpoint -q /media/D && lsof -t /media/D &> /dev/null; then
        drives_in_use=true
        break
    fi
    if mountpoint -q /media/E && lsof -t /media/E &> /dev/null; then
        drives_in_use=true
        break
    fi
done

# Notify user if drives are in use and log the message
if [ "$drives_in_use" = true ]; then
    log_message "warning" "Drives are currently in use. Defragmentation will be delayed."
    exit 1
fi

# Check fragmentation level of NTFS drives
defrag_needed=false

for drive in /dev/sda1 /dev/sdb1; do
    fragmentation=$(sudo ntfs-3g.info --file $drive | grep "Fragmentation" | awk '{print $NF}' | cut -d'%' -f1)
    
    if [ $fragmentation -gt 10 ]; then
        defrag_needed=true
        break
    fi
done

# Log fragmentation level and defragmentation status
log_message "info" "Fragmentation level: $fragmentation%."

# Defragment NTFS drives if needed
if [ "$defrag_needed" = true ]; then
    log_message "info" "Starting defragmentation of NTFS drives."

    for drive in /dev/sda1 /dev/sdb1; do
        if sudo ntfs-3g.defrag $drive; then
            log_message "info" "Defragmentation of $drive completed successfully."
        else
            log_message "error" "Error occurred during defragmentation of $drive."
        fi
    done

    log_message "info" "Defragmentation completed."
else
    log_message "info" "No defragmentation needed."
fi
